<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="Run">
  <PropertyGroup>
    <ApiPublishPath>$(MSBuildProjectDirectory)\deploy\api</ApiPublishPath>
    <HostPublishPath>$(MSBuildProjectDirectory)\deploy\host</HostPublishPath>
  </PropertyGroup>

  <Target Name="Run">
    <CallTarget Targets="Build;PublishApi;PublishHost" />
  </Target>

  <Target Name="Build">
    <MSBuild Projects="DotNetGroup.sln" 
             Properties="Configuration=Release" 
             Targets="Rebuild" />
  </Target>

  <Target Name="PublishApi">
    <MSBuild Projects="$(MSBuildProjectDirectory)\$(MSBuildThisFile)"
             Properties="Path=$(ApiPublishPath)"
             Targets="RemoveContent" />

    <MSBuild Projects="API\API.csproj" 
             Properties="Configuration=Release;WebProjectOutputDir=$(ApiPublishPath)\;OutDir=$(ApiPublishPath)\bin\"
             Targets="ResolveReferences;_CopyWebApplication" />
  </Target>

  <Target Name="PublishHost">
    <MSBuild Projects="$(MSBuildProjectDirectory)\$(MSBuildThisFile)"
             Properties="Path=$(HostPublishPath)"
             Targets="RemoveContent" />
    
    <MSBuild Projects="Host\Host.csproj"
             Properties="Configuration=Release;OutDir=$(HostPublishPath)"
             Targets="ResolveReferences;" />
  </Target>

  <Target Name="RemoveContent">
    <CreateItem Include="$(Path)\**\*">
      <Output TaskParameter="Include" ItemName="ExistingFiles"/>
    </CreateItem>
    <Delete Files="%(ExistingFiles.Identity)" />
    <RemoveDir Directories="$(Path)" />
  </Target>

</Project>