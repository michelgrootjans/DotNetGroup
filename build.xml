<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="Run">
  <PropertyGroup>
    <MSBuildCommunityTasksPath>$(MSBuildProjectDirectory)\Build\</MSBuildCommunityTasksPath>
    <ApiPublishPath>$(MSBuildProjectDirectory)\deploy\api</ApiPublishPath>
    <WebPublishPath>$(MSBuildProjectDirectory)\deploy\web</WebPublishPath>
    <HostPublishPath>$(MSBuildProjectDirectory)\deploy\host</HostPublishPath>
  </PropertyGroup>

  <Import Project="$(MSBuildCommunityTasksPath)\MSBuild.Community.Tasks.Targets" />

  <Target Name="Run">
    <CallTarget Targets="Build;PublishApi;PublishWeb;PublishHost" />
  </Target>

  <Target Name="Build">
    <MSBuild Projects="DotNetGroup.sln" 
             Properties="Configuration=Release" 
             Targets="Rebuild" />
  </Target>

  <Target Name="PublishApi" DependsOnTargets="Build">
    <MSBuild Projects="$(MSBuildProjectDirectory)\$(MSBuildThisFile)"
             Properties="Path=$(ApiPublishPath)"
             Targets="_RemoveContent" />

    <MSBuild Projects="API\API.csproj" 
             Properties="Configuration=Release;WebProjectOutputDir=$(ApiPublishPath)\;OutDir=$(ApiPublishPath)\bin\"
             Targets="Build;ResolveReferences;_CopyWebApplication" />

    <XmlMassUpdate ContentFile="$(ApiPublishPath)\Web.config"
                   ContentRoot="/configuration"
                   SubstitutionsFile="API\Web.substitution.config"
                   SubstitutionsRoot="/substitutions/production" />
  </Target>

  <Target Name="PublishWeb" DependsOnTargets="Build">
    <MSBuild Projects="$(MSBuildProjectDirectory)\$(MSBuildThisFile)"
             Properties="Path=$(WebPublishPath)"
             Targets="_RemoveContent" />

    <MSBuild Projects="Web\Web.csproj" 
             Properties="Configuration=Release;WebProjectOutputDir=$(WebPublishPath)\;OutDir=$(WebPublishPath)\bin\"
             Targets="Build;ResolveReferences;_CopyWebApplication" />

    <XmlMassUpdate ContentFile="$(WebPublishPath)\Web.config"
                   ContentRoot="/configuration"
                   SubstitutionsFile="Web\Web.substitution.config"
                   SubstitutionsRoot="/substitutions/production" />
  </Target>

  <Target Name="PublishHost" DependsOnTargets="Build">
    <MSBuild Projects="$(MSBuildProjectDirectory)\$(MSBuildThisFile)"
             Properties="Path=$(HostPublishPath)"
             Targets="_RemoveContent" />

    <MSBuild Projects="Host\Host.csproj"
             Properties="Configuration=Release;OutDir=$(HostPublishPath)"
             Targets="Build" />
  </Target>

  <Target Name="_RemoveContent">
    <Message Text="Removing all content from $(Path)" />
    <CreateItem Include="$(Path)\**\*">
      <Output TaskParameter="Include" ItemName="ExistingFiles"/>
    </CreateItem>
    <Delete Files="%(ExistingFiles.Identity)" />
    <RemoveDir Directories="$(Path)" />
  </Target>

</Project>